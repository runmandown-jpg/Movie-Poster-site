<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 10 Box Office Hits</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        h1 {
            font-family: 'Oswald', sans-serif;
        }
        .movie-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
        }
        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .director-link {
            cursor: pointer;
            text-decoration: underline;
        }
        .director-link:hover {
            color: #ef4444; /* text-red-500 */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen py-10 px-4 sm:px-8">
    <div class="max-w-7xl mx-auto">
        <h1 id="main-title" class="text-4xl sm:text-5xl font-extrabold text-center mb-6 tracking-wide">
            <span class="text-gray-400">Top 10</span> <span class="text-red-500">Box Office Hits</span>
        </h1>
        <p class="text-center text-gray-400 mb-10">
            Browse the top grossing movies by month.
        </p>

        <!-- Top Input controls -->
        <div class="flex flex-col items-center justify-center space-y-4 mb-12 max-w-2xl mx-auto">
            <!-- Top Button Container for All-Time and Anticipated -->
            <div class="flex flex-wrap justify-center gap-4 w-full">
                <button id="all-time-btn" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200">
                    All Time Top 10
                </button>
                <button id="anticipated-btn" class="px-4 py-2 bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-400 transition-colors duration-200">
                    Anticipated Movies
                </button>
                <button id="yearly-btn" class="px-4 py-2 bg-green-500 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-green-400 transition-colors duration-200">
                    Top 10 by Year
                </button>
            </div>
            <!-- End Top Button Container -->
            
            <div id="dynamic-controls" class="flex flex-wrap justify-center items-center gap-4 w-full">
                <div id="month-control" class="flex flex-col items-start w-36">
                    <label for="month-select" class="text-sm font-semibold text-gray-300 mb-1">Month</label>
                    <select id="month-select" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                </div>
                
                <div class="flex flex-col items-start w-28">
                    <label for="year-select" class="text-sm font-semibold text-gray-300 mb-1">Year</label>
                    <select id="year-select" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                </div>

                <div id="region-control" class="flex flex-col items-start w-28">
                    <label for="region-select" class="text-sm font-semibold text-gray-300 mb-1">Region</label>
                    <select id="region-select" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                </div>
            </div>
          
            <!-- Top Button Container for Prev/Next -->
            <div id="monthly-nav-controls" class="flex flex-wrap justify-center gap-4 w-full mt-4">
                <button id="prev-month-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Prev
                </button>
                <button id="next-month-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Next
                </button>
            </div>
            <!-- End Top Button Container -->
        </div>

        <!-- Movie Grid and Messages -->
        <div id="content-area" class="text-center text-lg text-gray-400 mt-20">
            <p>Loading movies...</p>
        </div>

        <!-- Director Movies Page -->
        <div id="director-page" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="director-title" class="text-3xl sm:text-4xl font-bold text-white"></h2>
                <button id="back-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Back to Movies
                </button>
            </div>
            <div id="director-movies-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-center"></div>
        </div>
    </div>

    <!-- Bottom Buttons Container -->
    <div id="monthly-nav-controls-bottom" class="flex flex-wrap justify-center gap-4 w-full mt-12 max-w-2xl mx-auto">
        <button id="prev-month-btn-bottom" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
            Prev
        </button>
        <button id="next-month-btn-bottom" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
            Next
        </button>
    </div>
    <!-- End Bottom Buttons Container -->
    
    <!-- Prime Banner with Corrected Text-Based Logo -->
    <div class="mt-12 bg-gray-800 p-8 rounded-xl shadow-xl flex flex-col sm:flex-row items-center justify-between space-y-6 sm:space-y-0 sm:space-x-8">
        <div class="flex flex-col items-center sm:items-start text-center sm:text-left space-y-2">
            <!-- Simple text for the logo -->
            <div class="flex items-center space-x-1">
                <span class="text-white text-3xl font-bold">prime video</span>
            </div>
            <p class="text-xl sm:text-2xl font-bold text-blue-400">
                Start your 30-day free trial
            </p>
            <p class="text-sm sm:text-base font-semibold text-gray-300 max-w-lg">
                Unlimited streaming of Movies & TV with Amazon Prime
            </p>
        </div>
        <a href="" id="prime-banner-link" target="_blank" rel="noopener noreferrer" class="px-8 py-4 bg-yellow-500 text-gray-900 font-bold text-lg rounded-full shadow-lg hover:bg-yellow-400 transition-colors duration-200 whitespace-nowrap">
            Start Free Trial
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =========================================================
            // ACTION REQUIRED: PASTE YOUR TMDb TOKEN HERE
            // This token is required to fetch movie data from the API.
            // =========================================================
            const TMDB_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3NmFjMzdmY2M2NTIyMDljODI2MWQ2M2RmYjNhNWJhYSIsIm5iZiI6MTc1NjQ5MDU0Mi4wODksInN1YiI6IjY4YjFlYjJlM2NhZmM5ZjEyYjU0ZGE2OSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.SuTr-jDVinXLwrFu2QpoozseO5TOeK7Uy_0HIPxqYZA";

            // === YOUR AMAZON ASSOCIATES TRACKING IDS HERE ===
            const amazonTrackingIdUK = 'botm0e-21'; 
            const amazonTrackingIdUS = 'botmus-20';
            
            // Mapping for TMDb region codes
            const tmdbRegionMapping = {
                "US": "US",
                "UK": "GB", // The correct TMDb code for United Kingdom
                "FR": "FR",
                "DE": "DE",
                "IN": "IN",
                "JP": "JP",
                "KR": "KR",
            };

            // Set the initial month to the previous month
            const previousMonthDate = new Date();
            previousMonthDate.setMonth(previousMonthDate.getMonth() - 1);
            let year = previousMonthDate.getFullYear();
            let month = previousMonthDate.getMonth() + 1;

            let region = "UK";
            let isAllTimeView = false;
            let isAnticipatedView = false;
            let isYearlyView = false;
            
            const contentArea = document.getElementById('content-area');
            const directorPage = document.getElementById('director-page');
            const directorTitle = document.getElementById('director-title');
            const directorMoviesGrid = document.getElementById('director-movies-grid');
            const backBtn = document.getElementById('back-btn');

            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            const regionSelect = document.getElementById('region-select');
            const dynamicControls = document.getElementById('dynamic-controls');
            const mainTitle = document.getElementById('main-title');
            const monthControl = document.getElementById('month-control');
            const regionControl = document.getElementById('region-control');
            const monthlyNavControls = document.getElementById('monthly-nav-controls');
            const monthlyNavControlsBottom = document.getElementById('monthly-nav-controls-bottom');
            
            // Select all buttons using querySelectorAll
            const prevMonthBtns = document.querySelectorAll('#prev-month-btn, #prev-month-btn-bottom');
            const nextMonthBtns = document.querySelectorAll('#next-month-btn, #next-month-btn-bottom');
            const allTimeBtn = document.getElementById('all-time-btn');
            const anticipatedBtn = document.getElementById('anticipated-btn');
            const yearlyBtn = document.getElementById('yearly-btn');
            const primeBannerLink = document.getElementById('prime-banner-link');
            
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            });

            // Populate dropdowns
            const years = Array.from({ length: 100 }, (_, i) => new Date().getFullYear() - i);
            years.forEach(y => {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearSelect.appendChild(option);
            });
            yearSelect.value = year;

            const months = [
                { value: 1, name: "January" }, { value: 2, name: "February" }, { value: 3, name: "March" },
                { value: 4, name: "April" }, { value: 5, name: "May" }, { value: 6, name: "June" },
                { value: 7, name: "July" }, { value: 8, name: "August" }, { value: 9, name: "September" },
                { value: 10, name: "October" }, { value: 11, name: "November" }, { value: 12, name: "December" },
            ];
            months.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.name;
                monthSelect.appendChild(option);
            });
            monthSelect.value = month;

            const regions = ["US", "UK", "FR", "DE", "IN", "JP", "KR"];
            regions.forEach(r => {
                const option = document.createElement('option');
                option.value = r;
                option.textContent = r;
                regionSelect.appendChild(option);
            });
            regionSelect.value = region;

            // Set the prime banner link based on the initial region
            if (region === 'UK') {
                primeBannerLink.href = `https://www.amazon.co.uk/prime?tag=${amazonTrackingIdUK}`;
            } else {
                primeBannerLink.href = `https://www.amazon.com/prime?tag=${amazonTrackingIdUS}`;
            }

            const fetchMovies = async () => {
                if (!TMDB_TOKEN) {
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">A valid TMDb token is required to fetch movies. Please edit the code to add your token.</div>`;
                    return;
                }
                
                contentArea.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 space-y-4">
                                              <div class="spinner"></div>
                                              <p class="text-center text-lg text-gray-400">Loading movies...</p>
                                             </div>`;
                
                if (isAllTimeView) {
                    mainTitle.innerHTML = 'All Time <span class="text-red-500">Top 10</span> Grossing Movies';
                    dynamicControls.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                    await fetchAndRenderAllTimeTop10();
                    return;
                }

                if (isAnticipatedView) {
                    mainTitle.innerHTML = '<span class="text-red-500">Upcoming Movies</span>';
                    dynamicControls.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                    await fetchAndRenderAnticipatedMovies();
                    return;
                }

                if (isYearlyView) {
                    mainTitle.innerHTML = `<span class="text-gray-400">Top 10</span> <span class="text-red-500">Movies of ${year}</span>`;
                    monthControl.classList.add('hidden');
                    regionControl.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                    await fetchAndRenderYearlyTop10();
                    return;
                }

                // Logic to handle future months and change sorting
                const today = new Date();
                const selectedDate = new Date(year, month - 1, 1);
                let sortBy = 'vote_count.desc';
                
                if (selectedDate > today) {
                    sortBy = 'popularity.desc';
                    mainTitle.innerHTML = `<span class="text-red-500">Upcoming Movies for ${months[month - 1].name} ${year}</span>`;
                } else {
                    mainTitle.innerHTML = `<span class="text-gray-400">Top 10</span> <span class="text-red-500">Box Office Hits</span>`;
                }

                dynamicControls.classList.remove('hidden');
                monthControl.classList.remove('hidden');
                regionControl.classList.remove('hidden');
                monthlyNavControls.classList.remove('hidden');
                monthlyNavControlsBottom.classList.remove('hidden');

                try {
                    const firstDay = `${year}-${String(month).padStart(2, "0")}-01`;
                    const lastDay = new Date(year, month, 0).getDate();
                    const lastDate = `${year}-${String(month).padStart(2, "0")}-${lastDay}`;
            
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?primary_release_date.gte=${firstDay}&primary_release_date.lte=${lastDate}&region=${region}&sort_by=${sortBy}&with_runtime.gte=60`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );
            
                    if (res.status === 401) {
                        throw new Error('401 - Unauthorized. Please check your TMDb token as it may be invalid or expired.');
                    }
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }
            
                    const data = await res.json();
                    const top10Movies = (data.results || []).slice(0, 10);
                    
                    const moviesWithPosters = top10Movies.filter(m => m.poster_path);

                    // Fetch streaming providers, director, and revenue for each movie
                    const moviesWithInfo = await Promise.all(
                        moviesWithPosters.map(async (movie) => {
                            // Get details including IMDB ID and Revenue
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const detailsData = await detailsRes.json();

                            // Get Credits to find the Director
                            const creditsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/credits`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const creditsData = await creditsRes.json();
                            const director = creditsData.crew.find(person => person.job === 'Director');
                            
                            // Use the new TMDb API endpoint for providers
                            let isAvailableOnPrime = false;
                            const providersRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/watch/providers`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const providersData = await providersRes.json();
                            
                            // Use the correct TMDb region code from our mapping
                            const providers = providersData.results[tmdbRegionMapping[region]];
                            
                            if (providers && providers.flatrate) {
                                isAvailableOnPrime = providers.flatrate.some(provider => 
                                    provider.provider_name === 'Amazon Prime Video'
                                );
                            }

                            return { 
                                ...movie, 
                                revenue: detailsData.revenue,
                                imdb_id: detailsData.imdb_id,
                                isAvailableOnPrime: isAvailableOnPrime,
                                director: director ? director.name : 'Unknown',
                                directorId: director ? director.id : null
                            };
                        })
                    );
                    
                    if (moviesWithInfo.length === 0) {
                        contentArea.innerHTML = `<div class="text-center text-lg text-gray-400 mt-20">No posters available for this month and region.</div>`;
                    } else {
                        renderMovies(moviesWithInfo);
                    }
                } catch (e) {
                    console.error(e);
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Failed to fetch movies: ${e.message}</div>`;
                }
            };
            
            const fetchAndRenderAllTimeTop10 = async () => {
                try {
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?sort_by=revenue.desc&with_runtime.gte=60&vote_count.gte=1000`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );
            
                    if (res.status === 401) {
                        throw new Error('401 - Unauthorized. Please check your TMDb token as it may be invalid or expired.');
                    }
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }
            
                    const data = await res.json();
                    const top10Movies = (data.results || []).slice(0, 10);
                    
                    const moviesWithPosters = top10Movies.filter(m => m.poster_path);

                    // Fetch streaming providers, director, and revenue for each movie
                    const moviesWithInfo = await Promise.all(
                        moviesWithPosters.map(async (movie) => {
                            // Get details including IMDB ID and Revenue
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const detailsData = await detailsRes.json();

                            // Get Credits to find the Director
                            const creditsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/credits`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const creditsData = await creditsRes.json();
                            const director = creditsData.crew.find(person => person.job === 'Director');
                            
                            let isAvailableOnPrime = false;
                            const providersRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/watch/providers`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const providersData = await providersRes.json();
                            
                            const providers = providersData.results[tmdbRegionMapping[region]];
                            
                            if (providers && providers.flatrate) {
                                isAvailableOnPrime = providers.flatrate.some(provider => 
                                    provider.provider_name === 'Amazon Prime Video'
                                );
                            }

                            return { 
                                ...movie, 
                                revenue: detailsData.revenue,
                                imdb_id: detailsData.imdb_id,
                                isAvailableOnPrime: isAvailableOnPrime,
                                director: director ? director.name : 'Unknown',
                                directorId: director ? director.id : null
                            };
                        })
                    );

                    if (moviesWithInfo.length === 0) {
                        contentArea.innerHTML = `<div class="text-center text-lg text-gray-400 mt-20">No posters available for the All-Time list.</div>`;
                    } else {
                        renderMovies(moviesWithInfo);
                    }
                } catch (e) {
                    console.error(e);
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Failed to fetch All-Time movies: ${e.message}</div>`;
                }
            };
            
            const fetchAndRenderAnticipatedMovies = async () => {
                try {
                    const today = new Date().toISOString().slice(0, 10);
                    // Fetch popular upcoming movies
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?sort_by=popularity.desc&primary_release_date.gte=${today}&with_runtime.gte=60`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );

                    if (res.status === 401) {
                        throw new Error('401 - Unauthorized. Please check your TMDb token as it may be invalid or expired.');
                    }
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }

                    const data = await res.json();
                    const top10Movies = (data.results || []).slice(0, 10);
                    
                    // Sort the fetched movies by release date (soonest first)
                    top10Movies.sort((a, b) => new Date(a.release_date) - new Date(b.release_date));

                    const moviesWithPosters = top10Movies.filter(m => m.poster_path);

                    // Fetch streaming providers and director for each movie
                    const moviesWithInfo = await Promise.all(
                        moviesWithPosters.map(async (movie) => {
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`,
                                {
                                    headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
                                }
                            );
                            const detailsData = await detailsRes.json();
                            
                            const creditsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/credits`,
                                {
                                    headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
                                }
                            );
                            const creditsData = await creditsRes.json();
                            const director = creditsData.crew.find(person => person.job === 'Director');

                            let isAvailableOnPrime = false;
                            const providersRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/watch/providers`,
                                { headers: { Authorization: `Bearer ${TMDB_TOKEN}` } }
                            );
                            const providersData = await providersRes.json();
                            const providers = providersData.results[tmdbRegionMapping[region]];

                            if (providers && providers.flatrate) {
                                isAvailableOnPrime = providers.flatrate.some(provider => 
                                    provider.provider_name === 'Amazon Prime Video'
                                );
                            }

                            return {
                                ...movie,
                                revenue: null, // Revenue isn't available for upcoming movies
                                imdb_id: detailsData.imdb_id,
                                isAvailableOnPrime: isAvailableOnPrime,
                                director: director ? director.name : 'Unknown',
                                directorId: director ? director.id : null
                            };
                        })
                    );
                    
                    if (moviesWithInfo.length === 0) {
                        contentArea.innerHTML = `<div class="text-center text-lg text-gray-400 mt-20">No anticipated movies found for this region.</div>`;
                    } else {
                        renderMovies(moviesWithInfo);
                    }
                } catch (e) {
                    console.error(e);
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Failed to fetch anticipated movies: ${e.message}</div>`;
                }
            };

            const fetchAndRenderYearlyTop10 = async () => {
                 try {
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?primary_release_year=${year}&sort_by=revenue.desc&with_runtime.gte=60&vote_count.gte=100`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );
            
                    if (res.status === 401) {
                        throw new Error('401 - Unauthorized. Please check your TMDb token as it may be invalid or expired.');
                    }
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }
            
                    const data = await res.json();
                    const top10Movies = (data.results || []).slice(0, 10);
                    
                    const moviesWithPosters = top10Movies.filter(m => m.poster_path);

                    // Fetch streaming providers, director, and revenue for each movie
                    const moviesWithInfo = await Promise.all(
                        moviesWithPosters.map(async (movie) => {
                            // Get details including IMDB ID and Revenue
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const detailsData = await detailsRes.json();

                            // Get Credits to find the Director
                            const creditsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/credits`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const creditsData = await creditsRes.json();
                            const director = creditsData.crew.find(person => person.job === 'Director');
                            
                            let isAvailableOnPrime = false;
                            const providersRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/watch/providers`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const providersData = await providersRes.json();
                            
                            const providers = providersData.results[tmdbRegionMapping[region]];
                            
                            if (providers && providers.flatrate) {
                                isAvailableOnPrime = providers.flatrate.some(provider => 
                                    provider.provider_name === 'Amazon Prime Video'
                                );
                            }

                            return { 
                                ...movie, 
                                revenue: detailsData.revenue,
                                imdb_id: detailsData.imdb_id,
                                isAvailableOnPrime: isAvailableOnPrime,
                                director: director ? director.name : 'Unknown',
                                directorId: director ? director.id : null
                            };
                        })
                    );

                    if (moviesWithInfo.length === 0) {
                        contentArea.innerHTML = `<div class="text-center text-lg text-gray-400 mt-20">No posters available for the All-Time list.</div>`;
                    } else {
                        renderMovies(moviesWithInfo);
                    }
                } catch (e) {
                    console.error(e);
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Failed to fetch yearly movies: ${e.message}</div>`;
                }
            };


            const renderMovies = (movies) => {
                const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' });
                
                contentArea.innerHTML = `
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-center">
                        ${movies.map(m => {
                            const amazonSearchQuery = encodeURIComponent(`${m.title} bluray`);
                            let amazonLink = '';
                            let buttonText = 'Buy on Amazon';
                            let primeLink = '';
                            
                            if (region === 'UK') {
                                amazonLink = `https://www.amazon.co.uk/s?k=${amazonSearchQuery}&tag=${amazonTrackingIdUK}`;
                                buttonText = 'Buy on Amazon UK';
                                primeLink = `https://www.amazon.co.uk/prime?tag=${amazonTrackingIdUK}`;
                            } else if (region === 'US') {
                                amazonLink = `https://www.amazon.com/s?k=${amazonSearchQuery}&tag=${amazonTrackingIdUS}`;
                                buttonText = 'Buy on Amazon US';
                                primeLink = `https://www.amazon.com/prime?tag=${amazonTrackingIdUS}`;
                            } else {
                                amazonLink = `https://www.amazon.com/s?k=${amazonSearchQuery}`;
                                buttonText = 'Buy on Amazon';
                                primeLink = `https://www.amazon.com/prime?tag=${amazonTrackingIdUS}`; // Default to US
                            }
                            
                            const imdbLink = m.imdb_id ? `https://www.imdb.com/title/${m.imdb_id}` : '#';
                            const imdbTarget = m.imdb_id ? '_blank' : '_self';
                            const imdbRel = m.imdb_id ? 'noopener noreferrer' : '';

                            // Determine the correct image source based on whether a poster path exists
                            const posterSrc = m.poster_path 
                                ? `https://image.tmdb.org/t/p/w500${m.poster_path}`
                                : `https://placehold.co/500x750/111/fff?text=${encodeURIComponent(m.title)}`;
                            
                            // Conditional info for anticipated movies vs. others
                            let movieInfoHtml = '';
                            if (isAnticipatedView) {
                                // Format the release date to show Month Year
                                const releaseDate = new Date(m.release_date);
                                const formattedDate = dateFormatter.format(releaseDate);
                                movieInfoHtml = `<p class="text-sm font-semibold text-gray-300 mt-1">Release: ${formattedDate}</p>`;
                            } else {
                                movieInfoHtml = `<p class="text-sm font-semibold text-gray-300 mt-1">Global Gross: <span class="text-green-500">${m.revenue > 0 ? formatter.format(m.revenue) : 'N/A'}</span></p>`;
                            }
                            
                            const directorHtml = m.directorId ? `
                                <span class="text-sm text-gray-400">
                                    Director: 
                                    <a class="director-link" data-director-id="${m.directorId}" data-director-name="${m.director}">
                                        ${m.director}
                                    </a>
                                </span>` : `<p class="text-sm text-gray-400">Director: N/A</p>`;

                            return `
                                <div class="relative flex flex-col rounded-xl overflow-hidden shadow-2xl transform hover:scale-105 transition-transform duration-300 movie-card">
                                    <a
                                        href="${imdbLink}"
                                        target="${imdbTarget}"
                                        rel="${imdbRel}"
                                    >
                                        <img
                                            src="${posterSrc}"
                                            alt="${m.title}"
                                            class="w-full h-auto object-cover"
                                        />
                                    </a>
                                    <div class="p-4 text-center bg-gray-800 flex-grow">
                                        <a
                                            href="${imdbLink}"
                                            target="${imdbTarget}"
                                            rel="${imdbRel}"
                                            class="block text-white text-base font-bold leading-tight line-clamp-2 hover:text-red-400 transition-colors duration-200 mb-2"
                                        >
                                            ${m.title}
                                        </a>
                                        ${directorHtml}
                                        ${movieInfoHtml}
                                        
                                        <div class="flex flex-col space-y-2 mt-2">
                                            <a href="${amazonLink}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 bg-yellow-500 text-gray-900 text-sm font-semibold rounded-full hover:bg-yellow-400 transition-colors duration-200">
                                                ${buttonText}
                                            </a>
                                            ${m.isAvailableOnPrime ? `
                                                <a href="${primeLink}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-full hover:bg-blue-500 transition-colors duration-200">
                                                    Watch on Prime
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };

            const fetchDirectorMovies = async (directorId, directorName) => {
                contentArea.classList.add('hidden');
                directorPage.classList.remove('hidden');
                directorTitle.textContent = `Movies by ${directorName}`;
                directorMoviesGrid.innerHTML = `
                    <div class="flex flex-col items-center justify-center mt-20 space-y-4 col-span-full">
                        <div class="spinner"></div>
                        <p class="text-center text-lg text-gray-400">Finding movies for ${directorName}...</p>
                    </div>`;

                try {
                    // Filter out movies shorter than 60 minutes
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?with_crew=${directorId}&with_runtime.gte=60&sort_by=primary_release_date.desc`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    
                    const moviesWithPosters = data.results.filter(m => m.poster_path).slice(0, 20);

                    const moviesWithImdbId = await Promise.all(
                        moviesWithPosters.map(async (movie) => {
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`,
                                { headers: { Authorization: `Bearer ${TMDB_TOKEN}` } }
                            );
                            const detailsData = await detailsRes.json();
                            return { ...movie, imdb_id: detailsData.imdb_id };
                        })
                    );
                    
                    if (moviesWithImdbId.length === 0) {
                        directorMoviesGrid.innerHTML = `<p class="text-center text-lg text-gray-400 mt-20 col-span-full">No movies found for this director.</p>`;
                    } else {
                         directorMoviesGrid.innerHTML = moviesWithImdbId.map(m => {
                            const posterSrc = m.poster_path 
                                ? `https://image.tmdb.org/t/p/w500${m.poster_path}`
                                : `https://placehold.co/500x750/111/fff?text=${encodeURIComponent(m.title)}`;
                                
                            const imdbLink = m.imdb_id ? `https://www.imdb.com/title/${m.imdb_id}` : '#';
                            const imdbTarget = m.imdb_id ? '_blank' : '_self';
                            const imdbRel = m.imdb_id ? 'noopener noreferrer' : '';

                            return `
                                <a
                                    class="relative flex flex-col rounded-xl overflow-hidden shadow-2xl transform hover:scale-105 transition-transform duration-300 movie-card"
                                    href="${imdbLink}"
                                    target="${imdbTarget}"
                                    rel="${imdbRel}"
                                >
                                    <img src="${posterSrc}" alt="${m.title}" class="w-full h-auto object-cover"/>
                                    <div class="p-4 text-center bg-gray-800 flex-grow">
                                        <p class="block text-white text-base font-bold leading-tight line-clamp-2">${m.title}</p>
                                        <p class="text-sm text-gray-400 mt-1">${m.release_date.split('-')[0]}</p>
                                    </div>
                                </a>
                            `;
                        }).join('');
                    }

                } catch (e) {
                    console.error(e);
                    directorMoviesGrid.innerHTML = `<p class="text-center text-lg text-red-400 mt-20 col-span-full">Failed to fetch director's movies: ${e.message}</p>`;
                }
            };


            const changeMonth = (dir) => {
                month += dir;
                if (month === 0) {
                    month = 12;
                    year -= 1;
                } else if (month === 13) {
                    month = 1;
                    year += 1;
                }
                yearSelect.value = year;
                monthSelect.value = month;
                fetchMovies();
            };

            const toggleView = (view) => {
                isAllTimeView = view === 'allTime';
                isAnticipatedView = view === 'anticipated';
                isYearlyView = view === 'yearly';

                // Reset button texts
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';

                // Update text for the active button
                if (isAllTimeView) {
                    allTimeBtn.textContent = 'Back to Monthly View';
                } else if (isAnticipatedView) {
                    anticipatedBtn.textContent = 'Back to Monthly View';
                } else if (isYearlyView) {
                    yearlyBtn.textContent = 'Back to Monthly View';
                }

                // Show/hide controls based on view
                if (isYearlyView) {
                    monthControl.classList.add('hidden');
                    regionControl.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                    dynamicControls.classList.remove('hidden');
                } else if (isAllTimeView || isAnticipatedView) {
                    dynamicControls.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                } else {
                    dynamicControls.classList.remove('hidden');
                    monthControl.classList.remove('hidden');
                    regionControl.classList.remove('hidden');
                    monthlyNavControls.classList.remove('hidden');
                    monthlyNavControlsBottom.classList.remove('hidden');
                }

                fetchMovies();
            };
            
            // Event Listeners
            yearSelect.addEventListener('change', (e) => {
                year = parseInt(e.target.value);
                fetchMovies();
            });

            monthSelect.addEventListener('change', (e) => {
                month = parseInt(e.target.value);
                fetchMovies();
            });

            regionSelect.addEventListener('change', (e) => {
                region = e.target.value;
                if (region === 'UK') {
                    primeBannerLink.href = `https://www.amazon.co.uk/prime?tag=${amazonTrackingIdUK}`;
                } else {
                    primeBannerLink.href = `https://www.amazon.com/prime?tag=${amazonTrackingIdUS}`;
                }
                fetchMovies();
            });
            
            allTimeBtn.addEventListener('click', () => toggleView(isAllTimeView ? 'monthly' : 'allTime'));
            anticipatedBtn.addEventListener('click', () => toggleView(isAnticipatedView ? 'monthly' : 'anticipated'));
            yearlyBtn.addEventListener('click', () => toggleView(isYearlyView ? 'monthly' : 'yearly'));

            // Universal "Back" button handler
            backBtn.addEventListener('click', () => {
                directorPage.classList.add('hidden');
                contentArea.classList.remove('hidden');
            });
            
            // Event delegation for director clicks
            document.addEventListener('click', (e) => {
                const directorLink = e.target.closest('.director-link');
                if (directorLink) {
                    e.preventDefault();
                    const directorId = directorLink.dataset.directorId;
                    const directorName = directorLink.dataset.directorName;
                    fetchDirectorMovies(directorId, directorName);
                }
            });

            prevMonthBtns.forEach(btn => btn.addEventListener('click', () => changeMonth(-1)));
            nextMonthBtns.forEach(btn => btn.addEventListener('click', () => changeMonth(1)));

            fetchMovies();
        });
    </script>
</body>
</html>
