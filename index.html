<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 10 Box Office Hits</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        h1 {
            font-family: 'Oswald', sans-serif;
        }
        .movie-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .director-link {
            cursor: pointer;
            text-decoration: underline;
        }
        .director-link:hover {
            color: #ef4444;
        }
        .poster-link:hover .movie-card {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);
            }
            100% { transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen py-10 px-4 sm:px-8">
    <div class="max-w-7xl mx-auto">
        <h1 id="main-title" class="text-4xl sm:text-5xl font-extrabold text-center mb-6 tracking-wide">
            <span class="text-gray-400">Top 10</span> <span class="text-red-500">Box Office Hits</span>
        </h1>
        <p class="text-center text-gray-400 mb-10">
            Browse the top grossing movies by month.
        </p>

        <!-- Top Input controls -->
        <div class="flex flex-col items-center justify-center space-y-4 mb-12 max-w-2xl mx-auto">
            <!-- Top Button Container for All-Time and Anticipated -->
            <div class="flex flex-wrap justify-center gap-4 w-full">
                <button id="all-time-btn" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200">
                All Time Top 10
                </button>
                <button id="anticipated-btn" class="px-4 py-2 bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-400 transition-colors duration-200">
                    Anticipated Movies
                </button>
                <button id="yearly-btn" class="px-4 py-2 bg-green-500 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-green-400 transition-colors duration-200">
                    Top 10 by Year
                </button>
            </div>
            <!-- End Top Button Container -->
            
            <!-- Random Buttons Container -->
            <div id="random-controls-top" class="flex flex-wrap justify-center gap-4 w-full">
                <button id="random-month-btn-top" class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 transition-colors duration-200">
                    Random Month
                </button>
                <button id="random-year-btn-top" class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 transition-colors duration-200">
                    Random Year
                </button>
            </div>
            <!-- End Random Buttons Container -->
            
            <div id="dynamic-controls" class="flex flex-wrap justify-center items-center gap-4 w-full">
                <div id="month-control" class="flex flex-col items-start w-36">
                    <label for="month-select" class="text-sm font-semibold text-gray-300 mb-1">Month</label>
                    <select id="month-select" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                </div>
                
                <div class="flex flex-col items-start w-28">
                    <label for="year-select" class="text-sm font-semibold text-gray-300 mb-1">Year</label>
                    <select id="year-select" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                </div>

                <div id="region-control" class="flex flex-col items-start w-28">
                    <label for="region-select" class="text-sm font-semibold text-gray-300 mb-1">Region</label>
                    <select id="region-select" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                </div>
            </div>

            <!-- Consolidated Navigation and Share Controls -->
            <div id="monthly-nav-controls" class="flex flex-wrap justify-center items-center gap-4 w-full mt-4">
                <button id="prev-month-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Prev
                </button>
                <button id="next-month-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Next
                </button>
                <button id="share-btn" class="bg-gray-700 text-white p-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                    <i class="fas fa-share-alt"></i>
                </button>
            </div>

            <!-- Top Button Container for Prev/Next for Yearly View -->
            <div id="yearly-nav-controls" class="hidden flex flex-wrap justify-center gap-4 w-full mt-4">
                <button id="prev-year-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Prev Year
                </button>
                <button id="next-year-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Next Year
                </button>
            </div>
            <!-- End Top Button Container for Yearly View -->

            <!-- Share URL box -->
            <div id="share-url-box" class="hidden w-full max-w-xl flex items-center bg-gray-700 rounded-lg p-2 border border-gray-600">
                <input id="share-url-input" type="text" readonly class="flex-grow bg-transparent text-sm text-white px-2 focus:outline-none">
                <button id="copy-btn" class="px-3 py-1 bg-green-500 text-gray-900 font-bold text-sm rounded-lg hover:bg-green-400 transition-colors duration-200">
                    Copy
                </button>
            </div>
            <div id="clipboard-message" class="hidden text-sm text-green-400 mt-2">Copied to clipboard!</div>
        </div>

        <!-- Movie Grid and Messages -->
        <div id="content-area" class="text-center text-lg text-gray-400 mt-20">
            <p>Loading movies...</p>
        </div>

        <!-- Director Movies Page -->
        <div id="director-page" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="director-title" class="text-3xl sm:text-4xl font-bold text-white"></h2>
                <button id="back-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
                    Back to Movies
                </button>
            </div>
            <div id="director-movies-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-center"></div>
        </div>
    </div>

    <!-- Bottom Buttons Container -->
    <div id="monthly-nav-controls-bottom" class="flex flex-wrap justify-center items-center gap-4 w-full mt-12 max-w-2xl mx-auto">
        <button id="prev-month-btn-bottom" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
            Prev
        </button>
        <button id="next-month-btn-bottom" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200">
            Next
        </button>
        <button id="share-btn-bottom" class="bg-gray-700 text-white p-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
            <i class="fas fa-share-alt"></i>
        </button>
        <button id="random-month-btn-bottom" class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 transition-colors duration-200">
            Random Month
        </button>
        <button id="random-year-btn-bottom" class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 transition-colors duration-200">
            Random Year
        </button>
    </div>
    <!-- End Bottom Buttons Container -->

    <!-- Prime Banner with Corrected Text-Based Logo -->
    <div class="mt-12 bg-gray-800 p-8 rounded-xl shadow-xl flex flex-col sm:flex-row items-center justify-between space-y-6 sm:space-y-0 sm:space-x-8">
        <div class="flex flex-col items-center sm:items-start text-center sm:text-left space-y-2">
            <!-- Simple text for the logo -->
            <div class="flex items-center space-x-1">
                <span class="text-white text-3xl font-bold">prime video</span>
            </div>
            <p class="text-xl sm:text-2xl font-bold text-blue-400">
                Start your 30-day free trial
            </p>
            <p class="text-sm sm:text-base font-semibold text-gray-300 max-w-lg">
                Unlimited streaming of Movies & TV with Amazon Prime
            </p>
        </div>
        <a href="" id="prime-banner-link" target="_blank" rel="noopener noreferrer" class="px-8 py-4 bg-yellow-500 text-gray-900 font-bold text-lg rounded-full shadow-lg hover:bg-yellow-400 transition-colors duration-200 whitespace-nowrap">
            Start Free Trial
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =========================================================
            // ACTION REQUIRED: PASTE YOUR TMDb TOKEN HERE
            // This token is required to fetch movie data from the API.
            // =========================================================
            const TMDB_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3NmFjMzdmY2M2NTIyMDljODI2MWQ2M2RmYjNhNWJhYSIsIm5iZiI6MTc1NjQ5MDU0Mi4wODksInN1YiI6IjY4YjFlYjJlM2NhZmM5ZjEyYjU0ZGE2OSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.SuTr-jDVinXLwrFu2QpoozseO5TOeK7Uy_0HIPxqYZA";
            
            // =========================================================
            // ACTION REQUIRED: PASTE YOUR AMAZON ASSOCIATES TRACKING IDS HERE
            // Your Amazon Associates tracking IDs for different regions.
            // These are required to generate the affiliate links.
            // =========================================================
            const amazonTrackingIdUS = 'botm0e-21';
            const amazonTrackingIdUK = 'botmus-20';
            
            // Mapping for TMDb region codes
            const tmdbRegionMapping = {
                "US": "US",
                "UK": "GB", // The correct TMDb code for United Kingdom
                "FR": "FR",
                "DE": "DE",
                "IN": "IN",
                "JP": "JP",
                "KR": "KR",
            };
            let year;
            let month;
            let region;
            let isAllTimeView = false;
            let isAnticipatedView = false;
            let isYearlyView = false;
            const contentArea = document.getElementById('content-area');
            const directorPage = document.getElementById('director-page');
            const directorTitle = document.getElementById('director-title');
            const directorMoviesGrid = document.getElementById('director-movies-grid');
            const backBtn = document.getElementById('back-btn');
            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            const regionSelect = document.getElementById('region-select');
            const dynamicControls = document.getElementById('dynamic-controls');
            const mainTitle = document.getElementById('main-title');
            const monthControl = document.getElementById('month-control');
            const regionControl = document.getElementById('region-control');
            const monthlyNavControls = document.getElementById('monthly-nav-controls');
            const monthlyNavControlsBottom = document.getElementById('monthly-nav-controls-bottom');
            const yearlyNavControls = document.getElementById('yearly-nav-controls');
            const shareUrlBox = document.getElementById('share-url-box');
            const shareUrlInput = document.getElementById('share-url-input');
            const copyBtn = document.getElementById('copy-btn');
            const clipboardMessage = document.getElementById('clipboard-message');
            // Select all buttons using querySelectorAll
            const prevMonthBtns = document.querySelectorAll('#prev-month-btn, #prev-month-btn-bottom');
            const nextMonthBtns = document.querySelectorAll('#next-month-btn, #next-month-btn-bottom');
            const shareBtns = document.querySelectorAll('#share-btn, #share-btn-bottom');
            const prevYearBtn = document.getElementById('prev-year-btn');
            const nextYearBtn = document.getElementById('next-year-btn');
            const allTimeBtn = document.getElementById('all-time-btn');
            const anticipatedBtn = document.getElementById('anticipated-btn');
            const yearlyBtn = document.getElementById('yearly-btn');
            const randomMonthBtns = document.querySelectorAll('#random-month-btn-top, #random-month-btn-bottom');
            const randomYearBtns = document.querySelectorAll('#random-year-btn-top, #random-year-btn-bottom');
            const primeBannerLink = document.getElementById('prime-banner-link');
            
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            });
            // Populate dropdowns
            const years = Array.from({ length: 100 }, (_, i) => new Date().getFullYear() - i);
            years.forEach(y => {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearSelect.appendChild(option);
            });
            yearSelect.value = year;

            const months = [
                { value: 1, name: "January" }, { value: 2, name: "February" }, { value: 3, name: "March" },
                { value: 4, name: "April" }, { value: 5, name: "May" }, { value: 6, name: "June" },
                { value: 7, name: "July" }, { value: 8, name: "August" }, { value: 9, name: "September" },
                { value: 10, name: "October" }, { value: 11, name: "November" }, { value: 12, name: "December" },
            ];
            months.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.name;
                monthSelect.appendChild(option);
            });
            monthSelect.value = month;

            const regions = ["US", "UK", "FR", "DE", "IN", "JP", "KR"];
            regions.forEach(r => {
                const option = document.createElement('option');
                option.value = r;
                option.textContent = r;
                regionSelect.appendChild(option);
            });
            const getParamsFromUrl = () => {
                const params = new URLSearchParams(window.location.search);
                const today = new Date();
                const previousMonthDate = new Date();
                previousMonthDate.setMonth(today.getMonth() - 1);

                year = parseInt(params.get('year') || previousMonthDate.getFullYear());
                month = parseInt(params.get('month') || (previousMonthDate.getMonth() + 1));
                region = params.get('region') || "UK";
                
                const view = params.get('view');
                isAllTimeView = view === 'alltime';
                isAnticipatedView = view === 'anticipated';
                isYearlyView = view === 'yearly';
                if (isAllTimeView) {
                    allTimeBtn.textContent = 'Back to Monthly View';
                } else if (isAnticipatedView) {
                    anticipatedBtn.textContent = 'Back to Monthly View';
                } else if (isYearlyView) {
                    yearlyBtn.textContent = 'Back to Monthly View';
                }

                yearSelect.value = year;
                monthSelect.value = month;
                regionSelect.value = region;
            };

            const generateShareUrl = () => {
                const baseUrl = window.location.origin + window.location.pathname;
                let params = new URLSearchParams();

                if (isAllTimeView) {
                    params.set('view', 'alltime');
                } else if (isAnticipatedView) {
                    params.set('view', 'anticipated');
                } else if (isYearlyView) {
                    params.set('view', 'yearly');
                    params.set('year', year);
                } else {
                    params.set('year', year);
                    params.set('month', month);
                    params.set('region', region);
                }
                
                return `${baseUrl}?${params.toString()}`;
            };

const fetchMovies = async () => {
                if (!TMDB_TOKEN) {
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">A valid TMDb token is required to fetch movies. Please edit the code to add your token.</div>`;
                    return;
                }
                
                contentArea.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 space-y-4">
                                              <div class="spinner"></div>
                                              <p class="text-center text-lg text-gray-400">Loading movies...</p>
                                             </div>`;

                // Handle the different view types first
                if (isAllTimeView) {
                    mainTitle.innerHTML = 'All Time <span class="text-red-500">Top 10</span> Grossing Movies';
                    dynamicControls.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                    yearlyNavControls.classList.add('hidden');
                    document.getElementById('random-controls-top').classList.add('hidden');
                    shareUrlBox.classList.add('hidden');
                    await fetchAndRenderAllTimeTop10();
                    return;
                }

                if (isAnticipatedView) {
                    mainTitle.innerHTML = '<span class="text-red-500">Upcoming Movies</span>';
                    dynamicControls.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                    yearlyNavControls.classList.add('hidden');
                    document.getElementById('random-controls-top').classList.add('hidden');
                    shareUrlBox.classList.add('hidden');
                    await fetchAndRenderAnticipatedMovies();
                    return;
                }

                if (isYearlyView) {
                    mainTitle.innerHTML = `<span class="text-gray-400">Top 10</span> <span class="text-red-500">Movies of ${year}</span>`;
                    monthControl.classList.add('hidden');
                    regionControl.classList.add('hidden');
                    monthlyNavControls.classList.add('hidden');
                    monthlyNavControlsBottom.classList.add('hidden');
                    dynamicControls.classList.remove('hidden');
                    document.getElementById('random-controls-top').classList.add('hidden');
                    yearlyNavControls.classList.remove('hidden');
                    shareUrlBox.classList.add('hidden');
                    await fetchAndRenderYearlyTop10();
                    return;
                }

                // Show and hide the correct controls
                dynamicControls.classList.remove('hidden');
                monthControl.classList.remove('hidden');
                regionControl.classList.remove('hidden');
                monthlyNavControls.classList.remove('hidden');
                monthlyNavControlsBottom.classList.remove('hidden');
                yearlyNavControls.classList.add('hidden');
                document.getElementById('random-controls-top').classList.remove('hidden');
                shareUrlBox.classList.add('hidden');

                const today = new Date();
                const selectedDate = new Date(year, month - 1, 1);
                
                let endpoint;
                let urlParams = new URLSearchParams();
                let sortBy;

                if (selectedDate > today) {
                    // Use the /discover/movie endpoint for future dates, but with a different sort
                    mainTitle.innerHTML = `<span class="text-red-500">Upcoming Movies for ${months[month - 1].name} ${year}</span>`;
                    endpoint = `https://api.themoviedb.org/3/discover/movie`;
                    sortBy = 'popularity.desc';
                } else {
                    // Use the /discover/movie endpoint for past and current dates
                    mainTitle.innerHTML = `<span class="text-gray-400">Top 10</span> <span class="text-red-500">Box Office Hits</span>`;
                    endpoint = `https://api.themoviedb.org/3/discover/movie`;
                    sortBy = 'revenue.desc';
                }

                // API call always uses discover endpoint and sorts by popularity for future dates.
                const firstDay = `${year}-${String(month).padStart(2, "0")}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const lastDate = `${year}-${String(month).padStart(2, "0")}-${lastDay}`;
                urlParams.set('primary_release_date.gte', firstDay);
                urlParams.set('primary_release_date.lte', lastDate);
                urlParams.set('region', tmdbRegionMapping[region]);
                urlParams.set('sort_by', sortBy);
                urlParams.set('with_runtime.gte', 60);
                urlParams.set('with_original_language', 'en');
                urlParams.set('without_genres', '10770,35'); // Excludes TV Movies (10770) and Comedy (35)

                try {
                    const res = await fetch(`${endpoint}?${urlParams.toString()}`, {
                        headers: {
                            Authorization: `Bearer ${TMDB_TOKEN}`,
                        },
                    });

                    if (res.status === 401) {
                        throw new Error('401 - Unauthorized. Please check your TMDb token as it may be invalid or expired.');
                    }
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }
                    const data = await res.json();
                    
                    const moviesToFetch = data.results || [];
                    const moviesWithInfo = await Promise.all(
                        moviesToFetch.map(async (movie) => {
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`, {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`
                                    }
                                }
                            );
                            const detailsData = await detailsRes.json();
                            const creditsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/credits`, {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`
                                    }
                                }
                            );
                            const creditsData = await creditsRes.json();
                            const director = creditsData.crew.find(person => person.job === 'Director');
                            const trailerRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/videos`, {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`
                                    }
                                }
                            );
                            const trailerData = await trailerRes.json();
                            const trailer = (trailerData.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer' && v.official);
                            let isAvailableOnPrime = false;
                            const providersRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/watch/providers`, {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`
                                    }
                                }
                            );
                            const providersData = await providersRes.json();
                            const providers = providersData.results[tmdbRegionMapping[region]];
                            if (providers && providers.flatrate) {
                                isAvailableOnPrime = providers.flatrate.some(provider => provider.provider_name === 'Amazon Prime Video');
                            }
                            return {
                                ...movie,
                                revenue: detailsData.revenue,
                                imdb_id: detailsData.imdb_id,
                                isAvailableOnPrime,
                                director: director ? director.name : 'Unknown',
                                directorId: director ? director.id : null,
                                trailerKey: trailer ? trailer.key : null,
                            };
                        })
                    );
                    
                    const moviesWithPosters = moviesWithInfo.filter(m => m.poster_path);
                    const top10Movies = moviesWithPosters.slice(0, 10);
                    
                    if (top10Movies.length > 0) {
                        renderMovies(top10Movies, false);
                    } else {
                        contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">No posters or revenue data available for this month and region.</div>`;
                    }

                } catch (error) {
                    console.error('Error fetching movies:', error);
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Error fetching movies: ${error.message}. Please try again later.</div>`;
                }
            };
            const fetchAndRenderAnticipatedMovies = async () => {
                try {
                    const today = new Date().toISOString().slice(0, 10);
                    // Fetch popular upcoming movies
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?sort_by=popularity.desc&primary_release_date.gte=${today}&with_runtime.gte=60`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );
                    if (res.status === 401) {
                        throw new Error('401 - Unauthorized. Please check your TMDb token as it may be invalid or expired.');
                    }
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }

                    const data = await res.json();
                    const top10Movies = (data.results || []).slice(0, 10);
                    
                    // Sort the fetched movies by release date (soonest first)
                    top10Movies.sort((a, b) => new Date(a.release_date) - new Date(b.release_date));
                    const moviesWithPosters = top10Movies.filter(m => m.poster_path);

                    // Fetch streaming providers, director, and trailer for each movie
                    const moviesWithInfo = await Promise.all(
                        moviesWithPosters.map(async (movie) => {
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`,
                                { headers: { Authorization: `Bearer ${TMDB_TOKEN}` } }
                            );
                            const detailsData = await detailsRes.json();
                            
                            const creditsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/credits`,
                                {
                                    headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
                                }
                            );
                            const creditsData = await creditsRes.json();
                            const director = creditsData.crew.find(person => person.job === 'Director');

                            const trailerRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/videos`,
                                { headers: { Authorization: `Bearer ${TMDB_TOKEN}` } }
                            );
                            const trailerData = await trailerRes.json();
                            const trailer = (trailerData.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer' && v.official);

                            let isAvailableOnPrime = false;
                            const providersRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/watch/providers`,
                                { headers: { Authorization: `Bearer ${TMDB_TOKEN}` } }
                            );
                            const providersData = await providersRes.json();
                            const providers = providersData.results[tmdbRegionMapping[region]];
                            if (providers && providers.flatrate) {
                                isAvailableOnPrime = providers.flatrate.some(provider => 
                                    provider.provider_name === 'Amazon Prime Video'
                                );
                            }

                            return { 
                                ...movie, 
                                revenue: detailsData.revenue,
                                imdb_id: detailsData.imdb_id,
                                isAvailableOnPrime: isAvailableOnPrime,
                                director: director ? director.name : 'Unknown',
                                directorId: director ? director.id : null,
                                trailerKey: trailer ? trailer.key : null,
                            };
                        })
                    );
                    if (moviesWithInfo.length === 0) {
                        contentArea.innerHTML = `<div class="text-center text-lg text-gray-400 mt-20">No anticipated movies with posters found.</div>`;
                    } else {
                        renderMovies(moviesWithInfo);
                    }
                } catch (e) {
                    console.error(e);
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Failed to fetch anticipated movies: ${e.message}</div>`;
                }
            };
            const fetchAndRenderYearlyTop10 = async () => {
                try {
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?primary_release_year=${year}&sort_by=revenue.desc&with_runtime.gte=60&vote_count.gte=1000`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );
                    if (res.status === 401) {
                        throw new Error('401 - Unauthorized. Please check your TMDb token as it may be invalid or expired.');
                    }
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }
                    const data = await res.json();
                    const top10Movies = (data.results || []).slice(0, 10);
                    
                    const moviesWithPosters = top10Movies.filter(m => m.poster_path);
                    // Fetch streaming providers, director, revenue, and trailer for each movie
                    const moviesWithInfo = await Promise.all(
                        moviesWithPosters.map(async (movie) => {
                            // Get details including IMDB ID and Revenue
                            const detailsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}?append_to_response=external_ids`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const detailsData = await detailsRes.json();

                            // Get Credits to find the Director
                            const creditsRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/credits`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const creditsData = await creditsRes.json();
                            const director = creditsData.crew.find(person => person.job === 'Director');
                            // Get trailer
                            const trailerRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/videos`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const trailerData = await trailerRes.json();
                            const trailer = (trailerData.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer' && v.official);

                            let isAvailableOnPrime = false;
                            const providersRes = await fetch(
                                `https://api.themoviedb.org/3/movie/${movie.id}/watch/providers`,
                                {
                                    headers: {
                                        Authorization: `Bearer ${TMDB_TOKEN}`,
                                    },
                                }
                            );
                            const providersData = await providersRes.json();
                            
                            const providers = providersData.results[tmdbRegionMapping[region]];
                            
                            if (providers && providers.flatrate) {
                                isAvailableOnPrime = providers.flatrate.some(provider => 
                                    provider.provider_name === 'Amazon Prime Video'
                                );
                            }

                            return { 
                                ...movie, 
                                revenue: detailsData.revenue,
                                imdb_id: detailsData.imdb_id,
                                isAvailableOnPrime: isAvailableOnPrime,
                                director: director ? director.name : 'Unknown',
                                directorId: director ? director.id : null,
                                trailerKey: trailer ? trailer.key : null,
                            };
                        })
                    );
                    if (moviesWithInfo.length === 0) {
                        contentArea.innerHTML = `<div class="text-center text-lg text-gray-400 mt-20">No posters available for this year and region.</div>`;
                    } else {
                        renderMovies(moviesWithInfo);
                    }
                } catch (e) {
                    console.error(e);
                    contentArea.innerHTML = `<div class="text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Failed to fetch yearly movies: ${e.message}</div>`;
                }
            };

            const renderMovies = (movies) => {
                directorPage.classList.add('hidden');
                contentArea.classList.remove('hidden');
                
                contentArea.innerHTML = `<div id="movie-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-5 gap-6 justify-center"></div>`;
                const movieGrid = document.getElementById('movie-grid');

                if (movies.length === 0) {
                    movieGrid.innerHTML = `<div class="col-span-full text-center text-lg text-gray-400 mt-20">No movies found. Please try a different month/year or region.</div>`;
                    return;
                }

                const amazonDomain = (region === 'US') ? '.com' : '.co.uk';
                const amazonTag = (region === 'US') ? amazonTrackingIdUS : amazonTrackingIdUK;
                
                movies.forEach(movie => {
                    const releaseDate = new Date(movie.release_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const revenueDisplay = movie.revenue ? `
                 <p class="text-sm text-gray-400 font-semibold mt-1">Global Gross: <span class="text-green-500">${formatter.format(movie.revenue)}</span></p>
` : '';
                    
                    const imdbLink = movie.imdb_id ? `https://www.imdb.com/title/${movie.imdb_id}` : '#';
                    const trailerButton = movie.trailerKey ? `
                        <div class="mt-2 text-center">
                            <a href="https://www.youtube.com/watch?v=${movie.trailerKey}" target="_blank" rel="noopener noreferrer" class="text-red-500 hover:text-red-400 transition-colors duration-200">
                                <i class="fab fa-youtube text-2xl"></i>
                            </a>
                        </div>
                    ` : '';
                    const directorLink = movie.directorId ? `
                        <p class="text-sm text-gray-400 mt-2">
                            Director: <span class="director-link" data-director-id="${movie.directorId}" data-director-name="${movie.director}">${movie.director}</span>
                        </p>
                    ` : `
                        <p class="text-sm text-gray-400 mt-2">Director: ${movie.director}</p>
                    `;
                    
                    const amazonSearchUrl = `https://www.amazon${amazonDomain}/s?k=${encodeURIComponent(movie.title)}&tag=${amazonTag}`;
                    
                     let actionButtonsHTML = '';
                    const rentOrBuyText = (region === 'US') ? 'Buy on Amazon US' : 'Buy on Amazon UK';
                    if (movie.isAvailableOnPrime) {
                        actionButtonsHTML = `
                            <div class="flex flex-col space-y-2 mt-4 w-full">
                                <a href="${amazonSearchUrl}" target="_blank" rel="noopener noreferrer" class="flex-1 px-3 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition-colors duration-200 text-center text-sm sm:text-base">
                                    Watch on Prime
                                </a>
                                <a href="${amazonSearchUrl}" target="_blank" rel="noopener noreferrer" class="flex-1 px-3 py-2 bg-yellow-500 text-gray-900 font-bold rounded-full hover:bg-yellow-400 transition-colors duration-200 text-center text-sm sm:text-base">
                                    ${rentOrBuyText}
                                </a>
                            </div>
                        `;
                    } else {
                        actionButtonsHTML = `
                            <a href="${amazonSearchUrl}" target="_blank" rel="noopener noreferrer" class="w-full mt-4 px-3 py-2 bg-yellow-500 text-gray-900 font-bold rounded-full hover:bg-yellow-400 transition-colors duration-200 text-center text-sm sm:text-base">
                                ${rentOrBuyText}
                            </a>
                        `;
                    }

                    const movieCard = document.createElement('div');
                    movieCard.className = `movie-card bg-gray-800 rounded-xl overflow-hidden shadow-lg flex flex-col`;
                    movieCard.innerHTML = `
                        <a href="${imdbLink}" target="_blank" rel="noopener noreferrer" class="block w-full poster-link">
                            <div class="relative pb-[150%]">
                                <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1f2937/d1d5db?text=No+Image';" alt="${movie.title}" class="absolute inset-0 w-full h-full object-cover rounded-t-xl">
                            </div>
                        </a>
                        <div class="p-4 flex flex-col items-center flex-grow">
                            <div class="text-center w-full">
<h3 class="text-white text-lg sm:text-xl font-bold line-clamp-2">${movie.title}</h3>
     </div>
                            <p class="text-sm text-gray-400 mt-1">${releaseDate}</p>
                            ${revenueDisplay}
                            ${directorLink}
                            ${trailerButton}
                            ${actionButtonsHTML}
                        </div>
                    `;
                    movieGrid.appendChild(movieCard);
                });
                
                document.querySelectorAll('.director-link').forEach(link => {
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const directorId = e.target.dataset.directorId;
                        const directorName = e.target.dataset.directorName;
                        if (directorId) {
                            await fetchDirectorMovies(directorId, directorName);
                        }
                    });
                });
            };

            const fetchDirectorMovies = async (directorId, directorName) => {
                contentArea.classList.add('hidden');
                directorPage.classList.remove('hidden');
                directorTitle.textContent = `Movies by ${directorName}`;
                directorMoviesGrid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center mt-20 space-y-4">
                                                    <div class="spinner"></div>
                                                    <p class="text-center text-lg text-gray-400">Loading ${directorName}'s filmography...</p>
                                                </div>`;
                
                try {
                    const res = await fetch(
                        `https://api.themoviedb.org/3/person/${directorId}/movie_credits`,
                        {
                            headers: {
                                Authorization: `Bearer ${TMDB_TOKEN}`,
                            },
                        }
                    );
                    if (!res.ok) {
                        throw new Error(`${res.status} - ${res.statusText}`);
                    }
                    const data = await res.json();
                    
                    const directedMovies = (data.crew || [])
                        .filter(movie => movie.job === 'Director' && movie.poster_path)
                        .sort((a, b) => new Date(b.release_date) - new Date(a.release_date));
                    
                    renderDirectorMovies(directedMovies);
                } catch (e) {
                    console.error(e);
                    directorMoviesGrid.innerHTML = `<div class="col-span-full text-center text-lg text-red-400 mt-20 p-4 bg-gray-800 rounded-lg">Failed to fetch director's movies: ${e.message}</div>`;
                }
            };
            const renderDirectorMovies = (movies) => {
                directorMoviesGrid.innerHTML = '';
                if (movies.length === 0) {
                    directorMoviesGrid.innerHTML = `<div class="col-span-full text-center text-lg text-gray-400 mt-20">No movies found for this director.</div>`;
                    return;
                }
                movies.forEach(movie => {
                    const releaseDate = movie.release_date ? new Date(movie.release_date).getFullYear() : 'N/A';
                    const movieCard = document.createElement('div');
                    const imdbLink = movie.imdb_id ? `https://www.imdb.com/title/${movie.imdb_id}` : '#';
                    movieCard.className = `movie-card bg-gray-800 rounded-xl overflow-hidden shadow-lg`;
                    movieCard.innerHTML = `
                        <a href="${imdbLink}" target="_blank" rel="noopener noreferrer" class="block w-full poster-link">
                            <div class="relative pb-[150%]">
                                <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1f2937/d1d5db?text=No+Image';" alt="${movie.title}" class="absolute inset-0 w-full h-full object-cover rounded-t-xl">
                            </div>
                        </a>
                        <div class="p-4">
                            <h3 class="text-lg font-bold line-clamp-2">${movie.title}</h3>
                            <p class="text-sm text-gray-400 mt-1">${releaseDate}</p>
                        </div>
                    `;
                    directorMoviesGrid.appendChild(movieCard);
                });
            };
            
            backBtn.addEventListener('click', () => {
                directorPage.classList.add('hidden');
                contentArea.classList.remove('hidden');
            });
            
            monthSelect.addEventListener('change', (e) => {
                month = parseInt(e.target.value);
                isAllTimeView = false;
                isAnticipatedView = false;
                isYearlyView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';
                fetchMovies();
            });

            yearSelect.addEventListener('change', (e) => {
                year = parseInt(e.target.value);
                isAllTimeView = false;
                isAnticipatedView = false;
                isYearlyView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';
                fetchMovies();
            });

            regionSelect.addEventListener('change', (e) => {
                region = e.target.value;
                isAllTimeView = false;
                isAnticipatedView = false;
                isYearlyView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';
                fetchMovies();
            });

            allTimeBtn.addEventListener('click', () => {
                isAllTimeView = !isAllTimeView;
                isAnticipatedView = false;
                isYearlyView = false;
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';
                allTimeBtn.textContent = isAllTimeView ? 'Back to Monthly View' : 'All Time Top 10';
                fetchMovies();
            });

            anticipatedBtn.addEventListener('click', () => {
                isAnticipatedView = !isAnticipatedView;
                isAllTimeView = false;
                isYearlyView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                yearlyBtn.textContent = 'Top 10 by Year';
                anticipatedBtn.textContent = isAnticipatedView ? 'Back to Monthly View' : 'Anticipated Movies';
                fetchMovies();
            });

            yearlyBtn.addEventListener('click', () => {
                isYearlyView = !isYearlyView;
                isAllTimeView = false;
                isAnticipatedView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = isYearlyView ? 'Back to Monthly View' : 'Top 10 by Year';
                fetchMovies();
            });

            prevMonthBtns.forEach(btn => btn.addEventListener('click', () => {
                isAllTimeView = false;
                isAnticipatedView = false;
                isYearlyView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';
                month--;
                if (month < 1) {
                    month = 12;
                    year--;
                }
                monthSelect.value = month;
                yearSelect.value = year;
                fetchMovies();
            }));

            nextMonthBtns.forEach(btn => btn.addEventListener('click', () => {
                isAllTimeView = false;
                isAnticipatedView = false;
                isYearlyView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';
                month++;
                if (month > 12) {
                    month = 1;
                    year++;
                }
                monthSelect.value = month;
                yearSelect.value = year;
                fetchMovies();
            }));

            prevYearBtn.addEventListener('click', () => {
                year--;
                yearSelect.value = year;
                fetchMovies();
            });

            nextYearBtn.addEventListener('click', () => {
                year++;
                yearSelect.value = year;
                fetchMovies();
            });
            
            randomMonthBtns.forEach(btn => btn.addEventListener('click', () => {
                isAllTimeView = false;
                isAnticipatedView = false;
                isYearlyView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = 'Top 10 by Year';
                month = Math.floor(Math.random() * 12) + 1;
                year = Math.floor(Math.random() * (new Date().getFullYear() - 1950 + 1)) + 1950;
                monthSelect.value = month;
                yearSelect.value = year;
                fetchMovies();
            }));

            randomYearBtns.forEach(btn => btn.addEventListener('click', () => {
                isYearlyView = !isYearlyView;
                isAllTimeView = false;
                isAnticipatedView = false;
                allTimeBtn.textContent = 'All Time Top 10';
                anticipatedBtn.textContent = 'Anticipated Movies';
                yearlyBtn.textContent = isYearlyView ? 'Back to Monthly View' : 'Top 10 by Year';
                const currentYear = new Date().getFullYear();
                const minYear = 1950;
                year = Math.floor(Math.random() * (currentYear - minYear + 1)) + minYear;
                yearSelect.value = year;
                fetchMovies();
            }));
            
            // Share URL event listeners
            shareBtns.forEach(btn => btn.addEventListener('click', () => {
                const url = generateShareUrl();
                shareUrlInput.value = url;
                shareUrlBox.classList.remove('hidden');
                shareUrlInput.select();
                shareUrlInput.focus();
            }));

            copyBtn.addEventListener('click', () => {
                shareUrlInput.select();
                try {
                    document.execCommand('copy');
                    clipboardMessage.classList.remove('hidden');
                    setTimeout(() => clipboardMessage.classList.add('hidden'), 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
            });
            
            // Initialize page based on URL parameters or defaults
            getParamsFromUrl();
            fetchMovies();
        });
    </script>
</body>
</html>

